<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Questions page</title>
    <link rel="stylesheet" href="stylesheet.css">
    <script src="js/instascan.min.js"></script>
    <script src="cookies.js"></script>
</head>
<body>

<video id="preview"></video>
<!-- for QR code-->
<!--<div style="margin: 20px; padding: 20px; background-color: black; color: white; text-align: center;" id="content"></div>-->

<h1> Treasure Hunt Questions</h1>
<div id="question_container">
    <p id="question_text"> Loading question </p> <br>
    <p id="answer_text"> Loading answer </p> <br>
    <p id="feedback_text"> Loading feedback </p>
    <p id="score_text"> Loading score </p>


</div>


<script>


const session=getCookie("sessionId");



function getQuestions()
{
    fetch(`https://codecyprus.org/th/api/question?session=${session}`)
        .then(response => response.json())
            .then(jsonObject => {
                console.log(jsonObject);

                let displayQuestion=document.getElementById("question_text");
                let giveAnswer = document.getElementById("answer_text");

                giveAnswer.innerHTML=""; //clear previous input


                if (jsonObject.status !== "OK")
                {
                    displayQuestion.textContent = "No questions found!";
                }
                else
                {
                   displayQuestion.textContent = jsonObject.questionText.split("<br>")[0].trim(); //read up to the <br>
                    const input = document.createElement("input");
                    input.id= "answer"; //we need a way to pass it to the check function

                //INTEGER
                if (jsonObject.questionType === "INTEGER")
                {
                    input.type = "number";
                    input.placeholder = "Enter your answer";
                }

                //BOOLEAN
                if (jsonObject.questionType === "BOOLEAN")
                {
                    input.type = "text";
                    input.placeholder = "Enter your answer";

                }
                //NUMERIC
                if (jsonObject.questionType === "NUMERIC")
                {
                    document.getElementById("question_text");
                    input.type = "number";
                    input.placeholder = "Enter your answer";

                }
                //MCQ
                if (jsonObject.questionType === "MCQ")
                {
                    input.type = "select";
                    input.placeholder = "Enter your answer";

                }
                //TEXT
                if (jsonObject.questionType === "TEXT")
                {
                    input.type = "text";
                    input.placeholder = "Enter your answer";

                }


                giveAnswer.appendChild(input);

                const submitButton = document.createElement("button");
                submitButton.textContent = "Check";
                submitButton.type="submit";
                submitButton.onclick = submitAnswers;
                giveAnswer.appendChild(submitButton);

                const skipButton = document.createElement("button");
                skipButton.textContent = "Skip Question";
                skipButton.type="button";
                skipButton.onclick = skipQuestion;
                giveAnswer.appendChild(skipButton);
                }
                // const answerByThePlayer=document.getElementById("answer_text").value;
                // setCookie("answerByThePlayer", answerByThePlayer);

               // if (jsonObject.canBeSkipped===true)
               //  {
               //      skipQuestion();
               //  }
               //  else{
               //      alert("Question cannot be skipped!");
               //  }
            });
}


getQuestions(); //call the function to display the answers

//const playersAnswers=document.getElementById("answer_text").value;



function submitAnswers()
{
    let playersAnswers=document.getElementById("answer").value;

    fetch(`https://codecyprus.org/th/api/answer?session=${session}&answer=${playersAnswers}`)
        .then(response => response.json())
        .then(jsonObject => {
            console.log(jsonObject);

            //display the message
            const feedback=document.getElementById("feedback_text");
            //feedback.innerHTML=""; //clear previous input


             if(jsonObject.status === "OK")
             {
                 feedback.textContent=jsonObject.message;
             }


                //call the questions function when there are more questions
            if(jsonObject.completed===false)
            {
                getQuestions();
            }
            else
            {
                window.location.href = "leaderboard.html";
            }

            // getLocation();
            if (jsonObject.requiresLocation === true)
            {
                input.type = "text";
                input.placeholder = "Enter your answer";
                getLocation();
            }



            //qr code for hint



          // }
        });
}

submitAnswers();

//skip
function skipQuestion()
    {

        fetch(`https://codecyprus.org/th/api/skip?session=${session}`)
            .then(response => response.json())
            .then(jsonObject => {
                console.log(jsonObject);

                    getQuestions();
            });

}

//leaderboard
function showLeaderboard() {
    fetch(`https://codecyprus.org/th/api/leaderboard?session=${session}&sorted&limit=10`)
        .then(response => response.json())
        .then(jsonObject => {
            console.log(jsonObject);


           const showPosition=document.getElementById("leaderBoard_container");
           showPosition.innerHTML="";
           showPosition.textContent=jsonObject.player+jsonObject.score; //+score

        });
}

            //geolocation

function sendLocationAndAnswerQuestion() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        }
        else {
        alert("Geolocation is not supported by your browser.");
    }
}

function showPosition(position) {
    alert("Latitude: " + position.coords.latitude + ", Longitude: " + position.coords.longitude);
    fetch(`https://codecyprus.org/th/api/location?session=${session}&latitude=${position.coords.latitude}&longitude=${position.coords.longitude}`)
        .then(response => response.json())
        .then(jsonObject => {
           if (jsonObject.status === "OK") {
               //TODO - Submit answer!
           }
           else {
               alert(jsonObject.message); //todo correct??
           }
        });
}


// //QR code reader
//             var opts = {
//                 // Whether to scan continuously for QR codes. If false, use scanner.scan() to
//                 // manually scan. If true, the scanner emits the "scan" event when a QR code is
//                 // scanned. Default true.
//                 continuous: true, // The HTML element to use for the camera's video preview. Must be a <video>
//                 // element. When the camera is active, this element will have the "active" CSS
//                 // class, otherwise, it will have the "inactive" class. By default, an invisible
//                 // element will be created to host the video.
//                 video: document.getElementById('preview'),
//                 // Whether to horizontally mirror the video preview. This is helpful when trying to
//                 // scan a QR code with a user-facing camera. Default true.
//                 mirror: true,
//                 // Whether to include the scanned image data as part of the scan result. See the
//                 // "scan" event for image format details. Default false.
//                 captureImage: false,
//                 // Only applies to continuous mode. Whether to actively scan when the tab is not
//                 // active.
//                 // When false, this reduces CPU usage when the tab is not active. Default true.
//                 backgroundScan: true,
//                 // Only applies to continuous mode. The period, in milliseconds, before the same QR
//                 // code will be recognized in succession. Default 5000 (5 seconds).
//                 refractoryPeriod: 5000,
//                 // Only applies to continuous mode. The period, in rendered frames, between scans. A
//                 // lower scan period increases CPU usage but makes scan response faster.
//                 // Default 1 (i.e. analyze every frame).
//                 scanPeriod: 1
//             };
//
// //The scanner listener - when a code is scanned, do something:
//             let scanner = new Instascan.Scanner(opts);
//             scanner.addListener('scan', function (content) {
//                 console.log(content);
//                 document.getElementById("content").innerHTML = content;
//             });
//
// //Initialize the cameras:
//             Instascan.Camera.getCameras().then(function (cameras)
//             {
//                 scanner.start(cameras[0]); //Start the default camera
//             }
//             ).catch(function (e) {
//                 alert(e);
//             });
//
// //switch to back camera on the phone
//             function switchCamera()
//             {
//                 //Cycle through the available cameras:
//                 if (cameraIndex < cameraArray.length - 1)
//                 {
//                     cameraIndex++;
//                 }
//                 else
//                 {
//                     cameraIndex = 0;
//                 }
//
//                 //Find the next camera to use:
//                 let camera = cameraArray[cameraIndex];
//
//                 //Start the new selected camera:
//                 scanner.start(camera);
//             }



</script>

</body>
</html>