<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LeaderBoard</title>
    <script src="cookies.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="stylesheet.css">
</head>
<body>

<div class="leaderboard">
<h1>Your Score:</h1>
<div id="score_container"></div>

<h1>Leader Board:</h1>
<div id="leaderBoard_container"></div>

<!-- Small UX improvement -->
<button id="refreshBtn" class="socialBtn">Refresh</button>

</div>

<script>

const session = getCookie("sessionId");
console.log(session);

// If no session, show message instead of undefined
if (!session) {
    document.getElementById("score_container").innerHTML =
        "No active session found. Please start a game first.";
    document.getElementById("leaderBoard_container").innerHTML =
        "Leaderboard unavailable without an active session.";
}
else {
    showPlayerScore();
    showLeaderBoard();
}

// Refresh button functionality
document.getElementById("refreshBtn").addEventListener("click", function () {
    if (session) {
        showPlayerScore();
        showLeaderBoard();
    }
});

// Player's score
function showPlayerScore() {
    fetch(`https://codecyprus.org/th/api/score?session=${session}`)
        .then(response => response.json())
        .then(jsonObject => {
            console.log(jsonObject);

            let score = document.getElementById('score_container');

            // Handle API error
            if (jsonObject.status && jsonObject.status !== "OK") {
                score.innerHTML = "Error loading score.";
                return;
            }

            score.innerHTML = jsonObject.score;
        })
        .catch(error => {
            document.getElementById('score_container').innerHTML =
                "Network error.";
        });
}

function showLeaderBoard() {
    fetch(`https://codecyprus.org/th/api/leaderboard?session=${session}&sorted=true&limit=10`)
        .then(response => response.json())
        .then(jsonObject => {
            console.log(jsonObject);

            let leaderBoardArray = jsonObject.leaderboard;
            let showPosition = document.getElementById("leaderBoard_container");
            showPosition.innerHTML = "";

            if (!leaderBoardArray || leaderBoardArray.length === 0) {
                showPosition.innerHTML = "No leaderboard data available.";
                return;
            }

            // FIXED LOOP CONDITION
            for (let i = 0; i < leaderBoardArray.length; i++) {
                let position = document.createElement("p");

                // Added ranking number
                position.innerHTML =
                    (i + 1) + ". " +
                    leaderBoardArray[i].player +
                    " â†’ " +
                    leaderBoardArray[i].score;

                showPosition.appendChild(position);
            }
        })
        .catch(error => {
            document.getElementById("leaderBoard_container").innerHTML =
                "Network error.";
        });
}

</script>

<br><br>
<h1>Thank you for playing our game!</h1>

<footer id="footer">
    <!-- removed trailing space in id -->
    <div id="FollowUs">
        <p>Follow us on:</p>

        <a href="https://www.instagram.com/web.busters5/" target="_blank">
            <button class="socialBtn">Instagram</button>
        </a>

        <a href="https://www.instagram.com/web.busters5/" target="_blank">
            <button class="socialBtn">TikTok</button>
        </a>

        <a href="https://x.com/Web_Busters5" target="_blank">
            <button class="socialBtn">Twitter</button>
        </a>
    </div>
</footer>

</body>
</html>
